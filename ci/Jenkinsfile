pipeline {
  agent any
  options { timestamps() }

  parameters {
    string(name: 'IMAGE_NAME', defaultValue: 'myapp', description: 'Docker image name to build & scan')
    string(name: 'DOCKERFILE', defaultValue: 'DemoApp.Dockerfile', description: 'Dockerfile to build')
    string(name: 'SEVERITY',   defaultValue: 'HIGH,CRITICAL', description: 'Fail gate on these severities')
  }

  environment {
    PYTHONUNBUFFERED = '1'
    DOCKER_BUILDKIT  = '1'
    DOCKER_HOST      = 'tcp://host.docker.internal:2375'
    // Jenkins job dir inside the jenkins_home volume:
    JOB_DIR          = '/jenkins_home/workspace/vuln-scanner-pipeline'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Docker Sanity (TCP)') {
      steps { sh 'docker version' }
    }

    stage('Build Docker image (TCP)') {
      steps {
        // Prove the file exists where we'll work inside the volume
        sh '''
          ls -la "${JOB_DIR}"
          test -f "${JOB_DIR}/${DOCKERFILE}" || { echo "❌ ${DOCKERFILE} not found at ${JOB_DIR}"; exit 2; }
        '''
        retry(2) {
          sh '''
            docker run --rm \
              -e DOCKER_HOST -e DOCKER_BUILDKIT \
              -e IMAGE_NAME -e DOCKERFILE -e BUILD_NUMBER \
              -v jenkins_home:/jenkins_home \
              -w "${JOB_DIR}" \
              docker:27.3-cli sh -lc '
                echo "Container CWD: $(pwd)"; ls -la .
                test -f "${DOCKERFILE}" || { echo "❌ ${DOCKERFILE} not visible inside container"; exit 3; }
                docker build -f "${DOCKERFILE}" -t "${IMAGE_NAME}:${BUILD_NUMBER}" .
              '
          '''
        }
      }
    }

    stage('Scan & Generate Report') {
      steps {
        sh '''
          # Ensure reports dir exists in the volume path
          mkdir -p "${JOB_DIR}/reports"
          docker run --rm \
            -e DOCKER_HOST \
            -e IMAGE_NAME -e BUILD_NUMBER -e SEVERITY \
            -v jenkins_home:/jenkins_home \
            -w "${JOB_DIR}" \
            -v /usr/bin/docker:/usr/bin/docker \
            python:3.11-slim bash -lc "
              ls -la .
              pip install --no-cache-dir -r requirements.txt &&
              python scanner/scan.py \\"${IMAGE_NAME}:${BUILD_NUMBER}\\" \\"reports/${IMAGE_NAME}.json\\" &&
              python scanner/report.py \\"reports/${IMAGE_NAME}.filtered.json\\" \\"reports/${IMAGE_NAME}.html\\"
            "
        '''
      }
    }

    stage('Email & Gate (Gmail)') {
      steps {
        withCredentials([
          string(credentialsId: 'GMAIL_USER',         variable: 'GMAIL_USER'),
          string(credentialsId: 'GMAIL_APP_PASSWORD', variable: 'GMAIL_APP_PASSWORD'),
          string(credentialsId: 'EMAIL_TO',           variable: 'EMAIL_TO')
        ]) {
          sh '''
            docker run --rm \
              -e DOCKER_HOST \
              -e IMAGE_NAME -e BUILD_NUMBER -e SEVERITY \
              -e GMAIL_USER -e GMAIL_APP_PASSWORD -e EMAIL_TO \
              -v jenkins_home:/jenkins_home \
              -w "${JOB_DIR}" \
              -v /usr/bin/docker:/usr/bin/docker \
              python:3.11-slim bash -lc "
                pip install --no-cache-dir -r requirements.txt &&
                python scanner/notify_email.py \
                  --image       \\"${IMAGE_NAME}:${BUILD_NUMBER}\\" \
                  --report-json \\"reports/${IMAGE_NAME}.filtered.json\\" \
                  --report-html \\"reports/${IMAGE_NAME}.html\\" \
                  --fail-on     \\"${SEVERITY}\\"
              "
          '''
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', onlyIfSuccessful: false
    }
  }
}
