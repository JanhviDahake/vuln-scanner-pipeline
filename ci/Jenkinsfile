pipeline {
  agent any

  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
    skipDefaultCheckout(true) // we do our own checkout
  }

  parameters {
    string(name: 'IMAGE_NAME', defaultValue: 'myapp', description: 'Docker image name to build & scan')
    string(name: 'DOCKERFILE', defaultValue: 'DemoApp.Dockerfile', description: 'Dockerfile path in repo')
    string(name: 'SEVERITY',   defaultValue: 'HIGH,CRITICAL', description: 'Gate fails if these severities are found')
    string(name: 'REPO_URL',   defaultValue: '', description: 'Git repo URL (blank = autodetect)')
    string(name: 'REPO_REF',   defaultValue: '', description: 'Git ref/branch/tag/sha (blank = autodetect)')
    choice(name: 'SCAN_MODE',  choices: ['os','full'], description: 'os = only OS packages (fast). full = OS + language deps.')
    booleanParam(name: 'SECRET_SCAN', defaultValue: false, description: 'Also run secret scanning (slower)')
  }

  environment {
    PYTHONUNBUFFERED = '1'
    DOCKER_BUILDKIT  = '1'
    DOCKER_HOST      = 'tcp://host.docker.internal:2375'  // adjust if different
    TRIVY_TAG        = 'latest'
    CACHE_VOLUME     = 'trivy-cache'
    REPORT_DIR       = 'reports'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Sanity: Docker TCP') {
      steps {
        sh '''#!/usr/bin/env bash
set -Eeuo pipefail
echo "Using DOCKER_HOST=${DOCKER_HOST}"
if docker -H "${DOCKER_HOST}" version >/dev/null 2>&1; then
  echo "✅ Docker reachable"
else
  echo "❌ Docker NOT reachable at ${DOCKER_HOST}" >&2
  exit 1
fi
'''
      }
    }

    stage('Resolve repo (autodetect if blanks)') {
      steps {
        script {
          def url = params.REPO_URL?.trim()
          if (!url) {
            url = sh(returnStdout: true, script: "git -C '${env.WORKSPACE}' config --get remote.origin.url").trim()
          }
          env.REPO_URL = url

          def ref = params.REPO_REF?.trim()
          if (!ref) {
            ref = sh(returnStdout: true, script: "git -C '${env.WORKSPACE}' rev-parse --abbrev-ref HEAD || echo HEAD").trim()
            if (!ref) { ref = 'HEAD' }
          }
          env.REPO_REF = ref

          echo "Using REPO_URL=${env.REPO_URL}, REPO_REF=${env.REPO_REF}"
        }
      }
    }

    stage('Build image from Git (no mounts)') {
      steps {
        sh '''#!/usr/bin/env bash
set -Eeuo pipefail
echo "Building ${IMAGE_NAME}:${BUILD_NUMBER} from ${REPO_URL}#${REPO_REF}"
DOCKER_BUILDKIT=0 docker -H "${DOCKER_HOST}" build \
  --pull \
  -f "${DOCKERFILE}" \
  -t "${IMAGE_NAME}:${BUILD_NUMBER}" \
  "${REPO_URL}#${REPO_REF}"

docker -H "${DOCKER_HOST}" images | grep -E "^${IMAGE_NAME}\\s+${BUILD_NUMBER}\\b" || true
'''
      }
    }

    stage('Warm Trivy DB cache (conditional)') {
      when {
        expression { params.SCAN_MODE == 'full' || params.SECRET_SCAN }
      }
      steps {
        sh '''#!/usr/bin/env bash
set -Eeuo pipefail
docker -H "${DOCKER_HOST}" volume create "${CACHE_VOLUME}" >/dev/null

# Main vuln DB
docker -H "${DOCKER_HOST}" run --rm \
  -v "${CACHE_VOLUME}:/root/.cache/trivy" \
  "aquasec/trivy:${TRIVY_TAG}" --download-db-only || true

# Java (for language deps) if doing full scan
if [[ "${SCAN_MODE:-os}" == "full" ]]; then
  docker -H "${DOCKER_HOST}" run --rm \
    -v "${CACHE_VOLUME}:/root/.cache/trivy" \
    "aquasec/trivy:${TRIVY_TAG}" --download-java-db-only || true
fi
'''
      }
    }

    stage('Scan & Generate Report') {
      steps {
        sh '''#!/usr/bin/env bash
set -Eeuo pipefail

# Defensive defaults so -u never trips on unset
: "${SECRET_SCAN:=false}"
: "${SCAN_MODE:=os}"
: "${SEVERITY:=HIGH,CRITICAL}"
: "${IMAGE_NAME:?IMAGE_NAME missing}"
: "${BUILD_NUMBER:?BUILD_NUMBER missing}"
: "${REPORT_DIR:=reports}"
: "${TRIVY_TAG:=latest}"
: "${CACHE_VOLUME:=trivy-cache}"

mkdir -p "${REPORT_DIR}"
docker -H "${DOCKER_HOST}" volume create "${CACHE_VOLUME}" >/dev/null

SCANNERS="vuln"
[[ "${SECRET_SCAN}" == "true" ]] && SCANNERS="vuln,secret"

if [[ "${SCAN_MODE}" == "os" ]]; then
  VULN_TYPE="os"
else
  VULN_TYPE="os,library"
fi

OUT_JSON="${IMAGE_NAME}.json"
OUT_HTML="${IMAGE_NAME}.html"
GATE_CODE="gate.code"

# Save the built image from the remote daemon to a local tar (no socket mount needed)
IMG_TAR="${WORKSPACE}/image.tar"
rm -f "${IMG_TAR}"
echo "Saving image ${IMAGE_NAME}:${BUILD_NUMBER} -> ${IMG_TAR}"
docker -H "${DOCKER_HOST}" save -o "${IMG_TAR}" "${IMAGE_NAME}:${BUILD_NUMBER}"

# Create Trivy container on the remote daemon
CID=$(docker -H "${DOCKER_HOST}" create \
  -v "${CACHE_VOLUME}:/root/.cache/trivy" \
  --entrypoint /bin/sh \
  "aquasec/trivy:${TRIVY_TAG}" -lc 'sleep infinity')

# Copy the image tar into the container
docker -H "${DOCKER_HOST}" cp "${IMG_TAR}" "$CID:/image.tar"

# Run scans inside the container
docker -H "${DOCKER_HOST}" exec "$CID" /bin/sh -lc '
set -e
mkdir -p /out
ec=0
trivy image \
  --timeout 10m \
  --scanners '"${SCANNERS}"' \
  --vuln-type '"${VULN_TYPE}"' \
  --severity "'"${SEVERITY}"'" \
  --format json -o /out/'"${OUT_JSON}"' \
  --exit-code 1 \
  --input /image.tar || ec=$?
echo $ec >/out/'"${GATE_CODE}"'

# HTML report (best-effort; fall back to table if template path ever changes)
if [ -f /contrib/html.tpl ]; then
  trivy image --timeout 10m --scanners '"${SCANNERS}"' --vuln-type '"${VULN_TYPE}"' --severity "'"${SEVERITY}"'" \
    --format template --template "@/contrib/html.tpl" -o /out/'"${OUT_HTML}"' \
    --input /image.tar || true
else
  trivy image --timeout 10m --scanners '"${SCANNERS}"' --vuln-type '"${VULN_TYPE}"' --severity "'"${SEVERITY}"'" \
    --format table > /out/'"${OUT_HTML}"' || true
fi
'

# Copy artifacts out and clean up
docker -H "${DOCKER_HOST}" cp "$CID:/out/." "${REPORT_DIR}/"
docker -H "${DOCKER_HOST}" rm -f "$CID" >/dev/null 2>&1 || true
rm -f "${IMG_TAR}"

echo "Reports written to ${REPORT_DIR}/${OUT_JSON} and ${REPORT_DIR}/${OUT_HTML}"
'''
      }
    }

    stage('Gate (fail on severity)') {
      steps {
        script {
          def code = sh(returnStdout: true, script: "cat '${env.REPORT_DIR}/gate.code' 2>/dev/null || echo 0").trim()
          echo "Trivy gate exit code: ${code}"
          if (code == '1') {
            currentBuild.result = 'FAILURE'
            error("Vulnerabilities of severity [${params.SEVERITY}] found in ${params.IMAGE_NAME}:${env.BUILD_NUMBER}")
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', onlyIfSuccessful: false
      // cleanWs() // uncomment if you want to wipe workspace
    }
  }
}
